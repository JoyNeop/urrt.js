var urrt = {
	'_cri': 0,
	'config': {
		'wpd': 60/310
	}
};

urrt.fae = function () {
	var e = document.querySelectorAll('h1, h2, h3, h4, h5, p, blockquote');
	var pels = [];
	for (var i = 0; i < e.length; i++) {
		var _tn = e[i].tagName.toLowerCase();
		var _w = e[i].innerText.trim().split(' ');
		for (var j = 0; j < _w.length; j++) {
			pels.push({
				tagName: _tn,
				word: _w[j]
			});
		};
	};
	return pels;
};

urrt.irv = function () {
	var _rvv = document.createElement('div');
	_rvv.innerHTML = '<div class="urrt-tc--cc"><div class="urrt-tc">Remaining<div id="urv--tr--inner" class="urrt-tc--in">**:**</div></div><div class="urrt-tc">Duration<div id="urv--te--inner" class="urrt-tc--in">**:**</div></div><div class="urrt-tc">Progress<div id="urv--tp--inner" class="urrt-tc--in">*%</div></div></div><div id="urv--progress-bar"><div id="urv--pb--in"></div></div><div id="urv--cc"></div>';
	_rvv.setAttribute('id', 'urv');
	_rvv.setAttribute('dtn', 'p');

	// Specify CSS
	var css = document.createElement('style');
	css.innerHTML = [
		'#urv {',
			'font-family: "Helvetica Neue", Helvetica, Arial, "Hiragino Sans GB", sans-serif;',
			'color: #000;',
			'text-align: center;',
			'background: rgba(255, 255, 255, 1);',
			'position: fixed;',
			'z-index: 99999;',
			'top: 0;',
			'left: 0;',
			'box-sizing: border-box;',
			'width: 100vw;',
			'height: 100vh;',
		'}',
		'.urrt-tc--cc { position: fixed; top: 30px; left: 10px; text-align: center; width: 100vw; }',
		'.urrt-tc { FS: 16px; color: #999; display: inline-block; padding: 0 22px 0; text-transform: lowercase; }',
		'.urrt-tc--in { FS: 28px; color: #666; display: block; }',
		'#urv--progress-bar { position: fixed; top: 0; left: 0; width: 100vw; height: 10px; }',
		'#urv--pb--in { background: #08C; width: 1px; height: 10px; -webkit-transition: all _DELAY_ms ease; transition: all _DELAY_ms ease;}'.replace(/_DELAY_/g, urrt.config.wpd*1000),
		'#urv--cc { padding-top: 29vh; }',
		'#urv[dtn="h1"] #urv--cc { FS: 94px; FW: 600; }',
		'#urv[dtn="h2"] #urv--cc { FS: 89px; FW: 600; }',
		'#urv[dtn="h3"] #urv--cc { FS: 84px; FW: 600; }',
		'#urv[dtn="h4"] #urv--cc { FS: 79px; FW: 600; }',
		'#urv[dtn="h5"] #urv--cc { FS: 74px; FW: 600; }',
		'#urv[dtn="h6"] #urv--cc { FS: 62px; FW: 400; }',
		'#urv[dtn="p"] #urv--cc { FS: 60px; FW: 300; }',
		'#urv[dtn="blockquote"] #urv--cc { FS: 60px; FW: 300; font-style: italic; }'
	].join('').replace(/FS/g, 'font-size').replace(/FW/g, 'font-weight');
	document.head.appendChild(css);

	// Put into document tree
	document.body.appendChild(_rvv);
};

urrt.go = function () {
	urrt.irv();

	var pels = urrt.fae();

	var _ct = function (_in) {
		var _t = Math.round(_in);
		var _m = Math.floor(_t/60);
		var _s = Math.floor(_t%60);
		_s = _s.toString().length == 1 ? '0' + _s.toString() : _s.toString();
		return (_m + ':' + _s);
	};

	// Calculate ETA
	document.getElementById('urv--te--inner').innerHTML = _ct( urrt.config.wpd * pels.length );

	urrt.updatingService = window.setInterval(function(){
		var _w = pels[urrt._cri].word;
		var _tn = pels[urrt._cri].tagName;

		var _hC = function (po) {
			var _tmpWord = _w.slice(0, po) + '<span style="color: red;">' + _w.slice(po, po + 1) + '</span>' + _w.slice(po + 1)
			return _tmpWord;
		};
		if (3 < _w.length < 6) {
			_w = _hC(1);
		} else if (5 < _w.length < 9) {
			_w = _hC(3);
		} else if (8 < _w.length < 11) {
			_w = _hC(4);
		} else if (10 < _w.length < 15) {
			_w = _hC(6);
		} else if (14 < _w.length) {
			_w = _hC(7);
		};

		if (_tn == 'blockquote') {
			_w = '<span style="color: #CCC; margin-right: 20px;">“</span><span style="border-bottom: 2px solid #EEE; padding-bottom: 8px;">' + _w + '</span><span style="color: #CCC; margin-left: 20px;">”</span>';
		};
		document.getElementById('urv').setAttribute('dtn', _tn);
		document.getElementById('urv--cc').innerHTML = _w;
		urrt._cri += 1;
		if (urrt._cri >= pels.length) {
			window.clearInterval(urrt.updatingService);
		};

		// Move progress bar
		document.getElementById('urv--pb--in').style.width = (urrt._cri/pels.length*100) + '%';

		// Update remaining time
		document.getElementById('urv--tr--inner').innerHTML = _ct(urrt.config.wpd * pels.length - urrt._cri * urrt.config.wpd);

		// Update progress percentage
		document.getElementById('urv--tp--inner').innerHTML = (urrt._cri/pels.length*100) == 100 ? ( '100%' ) : ( Math.floor(urrt._cri/pels.length*100) + '%');
	}, urrt.config.wpd*1000);
};

urrt.go();
